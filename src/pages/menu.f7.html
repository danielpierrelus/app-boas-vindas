<template>
	<div data-name="menu">
		<div class="page">
			<!-- ConteÃºdo da pÃ¡gina -->
			<div class="page-content">
				<div class="list no-margin margin-top">
					<ul>
						<li class="item-content item-input ">
							<div class="item-inner">
								<div class="item-input-wrap">
									<input class="text-align-center" type="text" placeholder="Selecione seu Campus" readonly="readonly"
									id="picker-device" disabled/>
								</div>
							</div>
							<div class="item-media align-self-center"><i class="f7-icons">pencil_circle_fill</i></div>
						</li>
					</ul>
				</div>

				<p id="welcome-button" style="max-height: 40px;"><a class="button button-fill sheet-open" id="welcome-popup" 
					  onclick="document.getElementById('welcome-button').className = 'hide'; localStorage.setItem('firstTime', 'false');"
					  href="#" data-sheet=".boas-vindas-pop"
					  style="display: flex; justify-content: space-evenly; max-height: 40px;">
					  Um minuto da sua atenÃ§Ã£o
					  <i class="f7-icons giggle">bell_fill</i>
					</a>
				</p>
				
				<div class="sheet-modal boas-vindas-pop" style="height:auto;">
					<div class="sheet-modal-inner">
					  <div class="page-content">
						<div class="block">
						  <p class='custom-text-title'>Estamos felizes em lhe receber ao aplicativo UFFS Virtual! ðŸ™‚</b></p>
						  <p>A equipe do <a class="link external" href="https://practice.uffs.edu.br">Practice</a> colocou muito amor e enforÃ§o neste aplicativo para deixar sua vida um pouquinho mais fÃ¡cil ðŸ¥°<br>
						  <br>Condensamos as informaÃ§Ãµes mais importantes para que vocÃª comece com o pÃ© direito, e preparad@ para sua tragetÃ³ria acadÃªmica!<br>
						  <p>EntÃ£o tire um tempinho para explorar tudo o que esse aplicativo tem a oferecer. E fique ciente que ainda estamos trabalhando para deixÃ¡-lo o mais redondinho o possÃ­vel ðŸ˜„</p>
						</div>
					  </div>
					</div>
				</div>

				<div>
					<div class="row margin">
						<div class="col-50 padding-half align-self-stretch menu-item-block elevation-1">
							<a href="/guia_calouros/" class=" menu-item-link">
								<div class="menu-item-content display-flex flex-direction-column align-items-center justify-content-space-between"
									style="height: 100%;">
									<div>
										<img src="static/images/school.png" class="menu-item-icon">
									</div>
									<div class="menu-item-title">Guia do Calouro</div>
								</div>
							</a>
						</div>

						<div class="col-50 padding-half align-self-stretch menu-item-block elevation-1">
							<a href="/procedures/" class=" menu-item-link">
								<div class="menu-item-content display-flex flex-direction-column align-items-center justify-content-space-between"
									style="height: 100%;">
									<div>
										<img src="static/images/school.png" class="menu-item-icon">
									</div>
									<div class="menu-item-title">Guia dos Procedimentos</div>
								</div>
							</a>
						</div>
					</div>


					{{#each staticTabsInfo}}
						{{#js_if "@index % 2 == 0"}}
						<div class="row margin">
						{{/js_if}}

							{{#unless active}}
						 	<div class="col-50 padding-half align-self-stretch menu-item-block elevation-1 disabled">
							{{else}}
							<div class="col-50 padding-half align-self-stretch menu-item-block elevation-1">
							{{/unless}}
								<a href="{{link}}" class="menu-item-link">
									<div class="menu-item-content display-flex flex-direction-column align-items-center justify-content-space-between"
										style="height: 100%;">
										<div>
											<img src="{{imgdark}}" class="menu-item-icon">
										</div>
										<div class="menu-item-title">{{title}}</div>
									</div>
								</a>
							</div>

						{{#js_if "@index % 2 == 1"}}
						</div>
						{{/js_if}}
					{{/each}}
				</div>
			</div>
		</div>
	</div>
</template>

<style>
	.disabled {
		pointer-events: none;
		cursor: default;
		filter: grayscale(100%);
	}

	.menu-item-block {
		border-radius: 20px;
		background-color: var(--f7-bars-bg-color);
	}

	img.menu-item-icon {
		height: 90px;
	}

	.menu-item-title{
		text-transform: uppercase;
		font-weight: bold;
		text-align: center;
	}

	.hide {
	visibility: hidden;
	opacity: 0;
	max-height: 0px !important;
	transition: max-height 0.3s, opacity 0.3s, visibility 0.3s linear;
	}

	.giggle {
		animation: giggle 2s infinite both;
	}

	@keyframes giggle {
		0%,
		100% {
			transform: translateX(0%);
			transform-origin: 50% 50%;
		}

		15% {
			transform: translateX(-10px) rotate(6deg);
		}

		30% {
			transform: translateX(5px) rotate(-6deg);
		}

		45% {
			transform: translateX(-5px) rotate(3.6deg);
		}

		60% {
			transform: translateX(3px) rotate(-2.4deg);
		}

		75% {
			transform: translateX(-2px) rotate(1.2deg);
		}
	}
</style>

<script>
	export default {
		data: function () {
			return {
				campus: null,
				tabs: ['sobre', 'clima', 'auxilio', 'lazer', 'projetos', 'canais', 'dicionario',
					'locomocao',
					'biblioteca', 'ajuda'
				],
				availableTabs : {},
				staticTabsInfo: null,
				spreadsheetContent: null,
				selectedCampus: null,
				smartSelect: null,
				picker: null
			}
		},
		
		methods: {
			Welcome: async function(){
				var self = this;
				var app = self.$app;
			
				if (localStorage.getItem('firstTime') == 'false') document.getElementById('welcome-popup').style.display = "none";

				app.sheet.create({
					el: '.boas-vindas-pop',
					swipeToClose: true,
					backdrop: true,
				});
			},

			loadTabsInfoFromJSON: async function(){
				var self = this;
				var app = self.$app;

				await app.request.json('static/json/menu-items.json', async function (data) {
					data.forEach((value, index) => {
						if(self.availableTabs[value.id]){
							value.active = true;
						}
					})

					self.$setState({
						staticTabsInfo: data,
					});
				})
			},
			startSmartSelect: async function() {
				var self = this;
				var app = self.$app;

				self.picker = app.picker.create({
					rotateEffect: true,
					freeMode: true,
					toolbarCloseText: `<i class="f7-icons">xmark_circle_fill</i>`,
					inputEl: '#picker-device',
					backdrop: true,
					cols: [
						{
							textAlign: 'center',
							values: []
						}
					],
					on: {
						change: () => {
							self.setSelectedCampusLink(self.picker.getValue());
						}
					}
				});
			},
			loadStorageData: async function() {
				var self = this;
				var app = self.$app;

				self.loadingEffects(true);

				await app.storage.getCampusInformation().then(campusInformation => {
					if(campusInformation){
						self.$setState({
							campus: campusInformation,
						});

						self.createPickerCampusArray(campusInformation);
					}
				});

				await app.storage.getSelectedCampus().then(selectedCampus => {
					if(selectedCampus){
						self.$setState({
							selectedCampus: selectedCampus,
						});
					}
				});

				await app.storage.getSpreadsheetContent().then(content => {
					if(content){
						self.$setState({
							spreadsheetContent: content,
						});
						self.loadingEffects(false);
					}
				});

				if(self.spreadsheetContent  && self.selectedCampus){
					self.displayContent();
					self.picker.setValue([self.selectedCampus.cidade], 100);
				}
				self.loadData();
			},
			loadData: async function () {
				var self = this;
				var app = self.$app;

				await app.api.getCampus().then(campus => {
					self.$setState({
						campus: campus,
					});
					app.storage.setCampusInformation(campus);
					self.createPickerCampusArray(campus);
				});

				var newSpreadsheetContent = [];

				for (let item of this.campus) {
					for (let tab of this.tabs) {
						await app.api.getCampusContent('https://opensheet.vercel.app/' + item.id + '/' + tab).then(data => {
							if (data) {
								newSpreadsheetContent.push([item.id, tab, data]);
							}
						});
					}
				}

				self.$setState({
					spreadsheetContent : newSpreadsheetContent,
				});

				app.storage.setSpreadsheetContent(newSpreadsheetContent);

				if(self.selectedCampus){
					self.picker.setValue([self.selectedCampus.cidade], 100);
				}
				
				self.loadingEffects(false);
			},
			setSelectedCampusLink: function (campusName) {
				var self = this;
				var app = self.$app;

				let found = self.campus.find(element => element.cidade == campusName);

				app.storage.setSelectedCampus(found);

				self.$setState({
					selectedCampus : found
				});

				self.displayContent();
			},
			displayContent: function() {
				var self = this;
				var app = self.$app;

				app.storage.removePageContent();

				let pageContent = {};

				for (let item of self.spreadsheetContent) {
					if (item[0] == self.selectedCampus.id && !item[2].error) {
						pageContent[item[1]] = item[2];
					}
				}

				self.availableTabs = {};

				self.availableTabs['guia_calouros'] = true;
				self.availableTabs['procedures'] = true;


				for(let tab of self.tabs){
					if(pageContent[tab]){
						self.availableTabs[tab] = true;
					}
				}

				app.storage.setPageContent(pageContent);

				self.setAvailableItems();
			},
			setAvailableItems: async function(){
				var self = this;
				var app = self.$app;

				let links = app.$$(".menu-item-link");

				links.each((index, value) => {
					let item = app.$$(value);
					let tabId = item.attr('href').replace('/content/', '').replaceAll('/', '');
					let parent = item.parent(".menu-item-block");
					if(!self.availableTabs[tabId]){
						parent.addClass('disabled');
					} else {
						parent.removeClass('disabled');
					}
				})
			},
			loadingEffects: async function(loading) {
				var self = this;
				var app = self.$app;

				await new Promise(resolve => setTimeout(resolve, 500));

				let menuItem = app.$$('.menu-item-content');
				let picker = app.$$('#picker-device');

				if(loading) {
					menuItem.addClass('skeleton-text');
					menuItem.addClass('skeleton-effect-blink');
					picker.prop({disabled: true});
					app.progressbar.show();
					return;
				} 
				menuItem.removeClass('skeleton-text');
				menuItem.removeClass('skeleton-effect-blink');
				picker.prop({disabled: false});
				app.progressbar.hide();
			},
			createPickerCampusArray: function(campusObject) {
				var self = this;
				var app = self.$app;

				var campusArray = []
				campusObject.forEach(element => {
					campusArray.push(element.cidade);
				});
				self.picker.params.cols[0].values = campusArray;
			}
		},
		on: {
			tabInit: async function (e, page) {
				var self = this;
				var app = self.$app;

				this.startSmartSelect();
				this.loadStorageData();
				this.loadTabsInfoFromJSON();

				this.Welcome();
			},
		}

	}
</script>