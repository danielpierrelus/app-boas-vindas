<template>
    <div class="page" data-name="diary">
        <div class="navbar">
            <div class="navbar-bg"></div>
            <div class="navbar-inner sliding">
                <div class="left">
                    <a href="/bemestar/" class="link back">
                        <i class="icon icon-back"></i>
                        <span class="if-not-md">Voltar</span>
                    </a>
                </div>
                <div class="title">Meu Diário</div>
            </div>
        </div>
        <div class="page-content" >
            <p class="block block-strong inset">Boas vindas ao seu diário! 😄 <br> Aqui você poderá relatar como você está se sentindo, é terapêutico, e vai ajudar você ao falar com mais certeza à algum especialista sobre como você se sentiu em determinado dia. <br></p>
            <div class="imessage">
                {{#each messages}}
                <div class="cloud-container">
                        <p class="from-me">{{ mensagem }}</p>
                        <p class="from-me-date">{{ data }}</p>
                </div>
				{{/each}}
            </div>
            <div class="text-editor text-editor-init" data-placeholder="Como você está se sentindo agora? 🖊️"  data-buttons='[[], []]'>
              <div class="text-editor-content" contenteditable></div>
            </div>
            <button @click="saveText()" class="button col button-outline button-round save-button">Salvar</button>
        </div>
    </div>
</template>
<script>
    export default {
        data: function() {
            let date = new Date();
            return {
                messages: null,
                today: ""+date.getDate()+'-'+(date.getMonth()+1)+'-'+date.getFullYear(),
            }
        },
        methods: {
            saveText: function () {
                var self = this;
                var app = self.$app;

                var textEditor = app.textEditor.get('.text-editor');
                
		        let date = new Date();
                let data = ""+date.getDate()+'-'+(date.getMonth()+1)+'-'+date.getFullYear();

                app.storage.setDiaryText(data, textEditor.getValue());
                this.showToastBottom();
            },
            showToastBottom: function () {
                let toastBottom;
                var self = this;
                var app = self.$app;
                if (!toastBottom) {
                    toastBottom = app.toast.create({
                        text: 'Seu texto foi salvo!',
                        closeTimeout: 3000,
                    });
                }
                toastBottom.open();
            },
            loadMessageFromJSON: async function () {
				var self = this;
				var app = self.$app;

                var diary_content = JSON.parse(localStorage.getItem("diary_content"));
                self.$setState({
					messages: diary_content,
				});
			},
        },
        on: {
            pageBeforein: async function () {
                let self = this;
                let app = self.$app;
		        
                let date = new Date();
                let data = ""+date.getDate()+'-'+(date.getMonth()+1)+'-'+date.getFullYear();

                this.loadMessageFromJSON();

                var textEditor = app.textEditor.get('.text-editor');
                var texto = [];
                texto = app.storage.getDiaryText(data);
                if (texto) {
                    textEditor.setValue(texto);
                } 
            }
        },
    };
</script>

<style>
    .save-button{
        background-color: var(--f7-bars-bg-color);
        width: 85%;
        margin-left: 7.5%;
    }
    .text-editor-content {
        font-size: var(--f7-block-font-size);
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.1), 0 6px 20px 0 rgba(0, 0, 0, 0.1);
    }
    .text-editor-toolbar{
        padding: 0;
    }
    .imessage {
        background-color: #fff;
        border: 1px solid #e5e5ea;
        border-radius: 0.25rem;
        display: flex;
        flex-direction: column;
        margin: 0 auto 1rem;
        max-width: 600px;
        padding: 0.5rem 1.5rem;
    }

    .imessage p {
        border-radius: 1.15rem;
        line-height: 1.25;
        max-width: 75%;
        position: relative;
        word-wrap: break-word;
    }

    p.from-them {
        align-items: flex-start;
        background-color: #e5e5ea;
        color: #000;
    }

    .cloud-container {
        border-radius: 1.15rem;
        line-height: 1.25;
        max-width: 75%;
        position: relative;
        word-wrap: break-word;
        background-color: #248bf5;
        display: flex;
        align-self: flex-end;
        flex-direction: column;
        margin-top: 15px;
    }
    p.from-me {
        align-self: flex-end;
        color: #fff;
        padding: 0.5rem .875rem;
    }
    p.from-me-date {
        align-self: flex-end;
        color: #e5e5ea;
        padding: 0rem .875rem;
        margin-top: 0px;
    }
</style>