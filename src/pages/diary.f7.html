<template>
    <div class="page" data-name="diary">
        <div class="navbar">
            <div class="navbar-bg"></div>
            <div class="navbar-inner sliding">
                <div class="left">
                    <a href="/bemestar/" class="link back">
                        <i class="icon icon-back"></i>
                        <span class="if-not-md">Voltar</span>
                    </a>
                </div>
                <div class="title">Meu Diário</div>
            </div>
        </div>
        <div class="page-content" >
            <p class="block block-strong inset">Boas vindas ao seu diário! 😄 <br> Aqui você poderá relatar como você está se sentindo, é terapêutico, e vai ajudar você ao falar com mais certeza à algum especialista sobre como você se sentiu em determinado dia. <br></p>
            <div>
            {{#js_if "../messages" }}
                <div class="imessage" id="mensagem">
                    {{#each messages}}
                    <div class="message-container">
                        <div class="cloud-container">
                            <div style="display: flex; align-self: flex-end; padding-right: 10px; padding-top: 5px">
                                <a @click="deleteText('{{ data }}'')"style="font-size: 10px; color: #fff;">x</a>
                            </div>
                            <p class="from-me">{{ mensagem }}</p>
                            <p class="from-me-date">{{ data }}</p>
                        </div>
                    </div>
                    {{/each}}
                </div>
            {{else}}
            <div class="block block-strong inset">
                <p>Você ainda não possui diário, comece a escrever agora mesmo! 🙂</p>
            </div>
            {{/js_if}}
            </div>
            <div class="text-editor text-editor-init" style="height: 8.2rem; margin-top: 35px" data-placeholder="Como você está se sentindo agora? 🖊️"  data-buttons='[[], []]'>
              <div class="text-editor-content" contenteditable></div>
            </div>
            <button @click="saveText()" class="button col button-outline button-round save-button">Salvar</button>
        </div>
    </div>
</template>
<script>
    export default {
        data: function() {
            let date = new Date();
            return {
                messages: null,
                today: ""+date.getDate()+'-'+(date.getMonth()+1)+'-'+date.getFullYear(),
                darkTheme: null
            }
        },
        methods: {
            saveText: function () {
                var self = this;
                var app = self.$app;

                var textEditor = app.textEditor.get('.text-editor');
                
		        let date = new Date();
                let data = ""+date.getDate()+'-'+(date.getMonth()+1)+'-'+date.getFullYear();

                app.storage.setDiaryText(data, textEditor.getValue());
                this.showToastBottom('false');
            },
            deleteText: function (dia) {
                var self = this;
                var app = self.$app;

                var diary_content = JSON.parse(localStorage.getItem('diary_content'));

                var index = -1;
                for (var i = 0; i < diary_content.length; i++) {
                    if (diary_content[i]['data'] == dia) {
                        index = i;
                    }
                }

                if ( index > -1 ) {
                    diary_content.splice(index, 1);
                }

                // não esta funcionando
                if ( diary_content.lenght == 0 ) {
                    localStorage.removeItem('diary_content');
                }

                localStorage.setItem('diary_content', JSON.stringify(diary_content));
                this.showToastBottom('true');
            },
            showToastBottom: function (temp) {
                let toastBottom;
                var self = this;
                var app = self.$app;
                if (!toastBottom) {
                    if ( temp == 'false' ) {
                        toastBottom = app.toast.create({
                        text: 'Seu texto foi salvo!',
                        closeTimeout: 3000,
                        });
                    }
                    else if ( temp == 'true') {
                        toastBottom = app.toast.create({
                        text: 'Seu texto foi deletado!',
                        closeTimeout: 3000,
                        });
                    }
                    else {
                        toastBottom = app.toast.create({
                        text: 'Seu texto não foi salvo!',
                        closeTimeout: 3000,
                        });
                    }
                }
                toastBottom.open();
            },
            loadMessageFromJSON: async function () {
				var self = this;
				var app = self.$app;

                var diary_content = JSON.parse(localStorage.getItem("diary_content"));
                self.$setState({
					messages: diary_content,
				});
			},
            loadMenuDarkModeInformation: async function () {
				var self = this;
				var app = self.$app;

				if (app.$$("#app").hasClass('theme-dark')) {
					self.$setState({
						darkTheme: true
					});
					return;
				}

				self.$setState({
					darkTheme: false
			    });
			},
        },
        on: {
            pageBeforein: async function () {
                let self = this;
                let app = self.$app;
		        
                let date = new Date();
                let data = ""+date.getDate()+'-'+(date.getMonth()+1)+'-'+date.getFullYear();

                this.loadMessageFromJSON();

                var textEditor = app.textEditor.get('.text-editor');
                var texto = [];
                texto = app.storage.getDiaryText(data);
                if (texto) {
                    textEditor.setValue(texto);
                } 
            }
        },
    };
</script>

<style>
    .save-button{
        background-color: var(--f7-bars-bg-color);
        width: 85%;
        margin-left: 7.5%;
    }
    .text-editor-content {
        font-size: var(--f7-block-font-size);
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.1), 0 6px 20px 0 rgba(0, 0, 0, 0.1);
    }
    .text-editor-toolbar{
        padding: 0;
    }
    .imessage {
        max-height: 16rem;
        overflow: auto;
        display: flex;
        flex-direction: column;
        margin: 0 auto 1rem;
        max-width: 600px;
        padding: 0.5rem 1.5rem;
    }
    .imessage p {
        border-radius: 1.15rem;
        line-height: 1.25;
        position: relative;
        word-wrap: break-word;
    }

    .cloud-container {
        border-radius: 1.15rem;
        line-height: 1.25;
        max-width: 75%;
        position: relative;
        word-wrap: break-word;
        background-color: #248bf5;
        display: flex;
        align-self: flex-start;
        flex-direction: column;
        margin-top: 15px;
    }
    p.from-me {
        align-self: flex-start;
        color: #fff;
        padding: 0.5rem .875rem;
    }
    p.from-me-date {
        align-self: flex-start;
        color: #e5e5ea;
        padding: 0rem .875rem;
        margin-top: 0px;
    }
    .message-container {
        display: flex;

    }
</style>